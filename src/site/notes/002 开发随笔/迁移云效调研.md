---
{"dg-publish":true,"permalink":"/002 开发随笔/迁移云效调研/","dgPassFrontmatter":true,"created":"2024-09-26T09:47:10.647+08:00","updated":"2024-10-15T17:20:27.679+08:00"}
---

DevOps，敏捷开发，Workflow

>软件研发是一个复杂的过程，涉及“需求->开发->测试->发布->运营”的复杂流程。

云效是阿里云提供的一站式 [[TP04 计算机技术/什么是DevOps\|DevOps]]平台，提供涵盖软件研发全生命周期的研发工具链和研发管理服务，并支持公共云、专有云多种部署形态。通过云原生新技术和研发新模式，助力创新创业和数字化转型企业快速实现研发敏捷和组织敏捷，打造“双敏”组织，实现多倍效能提升。

[如何快速了解使用云效2020\_云效(Apsara Devops)-阿里云帮助中心](https://help.aliyun.com/zh/yunxiao/getting-started/web-side-quick-start?spm=a2c4g.11186623.0.0.5614b39fKGORFp)
# 迁移代码仓库

因为公司目前的 GitLab 在公网中没有开放端口。所以阿里云提供的几种便捷迁移仓库方案不适合我们，我所我们采用的方案是先将所有代码仓库拉到本地在上传到云效中，好在阿里云也提供了这种场景，如下：

[如何使用迁移工具迁移自建Gitlab数据\_云效(Apsara Devops)-阿里云帮助中心](https://help.aliyun.com/zh/yunxiao/user-guide/self-built-gitlab-migration?spm=a2c4g.11186623.0.0.9a6261f1OoLsC1)
## 安装本地迁移工具

[如何安装本地迁移工具\_云效(Apsara Devops)-阿里云帮助中心](https://help.aliyun.com/zh/yunxiao/user-guide/install-the-local-migration-tool?spm=a2c4g.11186623.0.0.9a621ed52dBtNX)

![Pasted image 20240926142752.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240926142752.png)
## 定义迁移配置文件

```shell
./codeup-cli init
```

具体配置文件如下做参考：
### config.yml

```yml
import:
  source:
      platform: gitlab
      apiEndpoint: http://code.kanasinfo.cn
      accessToken: 
      host: http://code.kanasinfo.cn/swanlab-platform
      localSSHKeyPath: /Users/cloudswhite/.ssh/id_rsa
      asMember: true
  target:
      platform: codeup
      apiEndpoint: devops.cn-hangzhou.aliyuncs.com
      accessToken: 
      host: codeup.aliyun.com
      accessKey: 
      secretKey: 
      orgID: 
      localSSHKeyPath: /Users/cloudswhite/.ssh/id_rsa
  projectlistpath: projects.csv
  usermappath: users.csv
  workdir: /Users/cloudswhite/person/项目/SMS迁移云效/workpace
```
### projects.csv

```shell
./codeup-cli import --gen user
```

![Pasted image 20240926160151.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240926160151.png)
## 执行命令

1. 将本机公钥添加到 codeup 中，然后执行以下命令：

```shell
ssh -T git@codeup.aliyun.com
./codeup-cli import --run true
```
# 持续集成

## 添加私有集群

在将代码上传到 codeup 上之后，下一步需要为项目构建一个持续集成的测试环境。但是我们的所有项目都是跑在本地的集群上。所以第一步需要在 codeup 里添加一个私有集群。官方教程如下：

[如何构建集群\_云效(Apsara Devops)-阿里云帮助中心](https://help.aliyun.com/zh/yunxiao/user-guide/build-a-cluster?spm=a2cl9.flow_devops2020_goldlog_detail.0.0.4e1146f6dPVpUj)
### 创建集群

进入 Flow 首页 > **全局设置** > **构建集群管理** > **新建构建集群**，填写**构建集群名称**、**标签**、**拥有者**等信息，单击确定即可新建一个构建集群。

![Pasted image 20240930134125.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240930134125.png)
### 接入新节点

进入 Flow 首页 > **企业设置** > **构建集群管理**，找到目标构建集群，单击进入构建集群详情页，单击**接入新节点**。目前支持接入 Linux（amd64/arm64架构）、Windows（amd64架构）、macOS（amd64/arm64架构）机器作为构建机。
#### 接入 Linux 构建机

- **手动安装Runner**：直接复制 Runner 安装命令在待接入的机器上执行，Runner 安装成功后，新机器将自动添加至当前集群，请刷新主机列表后查看。

![Pasted image 20240930134321.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240930134321.png)
## 配置触发源

在提交代码到指定分支的时候自动触发构建流程

![Pasted image 20241009135410.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020241009135410.png)
## 基于本机的环境构建项目
### node 项目

选择上一步创建的集群，环境使用集群物理机本地机器上的环境构建，最后填写一下构建脚本

![Pasted image 20241009135527.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020241009135527.png)
### docker 部署

同上，只需要修改一下构建脚本即可

![Pasted image 20241009135904.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020241009135904.png)