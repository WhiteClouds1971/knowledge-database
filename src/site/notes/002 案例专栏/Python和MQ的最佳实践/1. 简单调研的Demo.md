---
{"dg-publish":true,"permalink":"/002 案例专栏/Python和MQ的最佳实践/1. 简单调研的Demo/","dgPassFrontmatter":true,"created":"2024-05-21T17:54:54.585+08:00","updated":"2024-06-01T10:45:29.190+08:00"}
---

# 需求梳理

要求做一个 Python 程序和 MQ 之间通信的最佳实践调研的 Demo。

![Pasted image 20240524143940.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240524143940.png)

1. 什么是 MQ
2. MQ 选型
3. MQ 如何部署
4. MQ 如何使用订阅和发布
5. 搭建 Python 环境
6. Python Web 容器选型
7. Python 程序和 MQ 之间通信
# MQ

[[001 读书笔记/IT黑马微服务/实用篇/04 Rabbit MQ\|参见 初识RabbitMQ]]
# Python

 1. 安装 Python 运行环境

```zsh
brew install python
```

2. 安装 PIP

```zsh
python3 -m ensurepip --upgrade

each 'export PATH="/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/site-packages:$PATH' >> ~/.zsh
source ~/.zshrc

pip3 -V
```

## Django 框架的快速入门

## 安装 Django

```zsh
pip3 install django
```
## 创建一个Django 站点

```zsh
django-admin startproject DjangoMqDemo

cd DjangoMqDemo

python3 manage.py runserver --noreload
```

测试：

![Pasted image 20240522155125.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240522155125.png)
## Django工程目录详解

![Pasted image 20240522155550.png](/img/user/$/$Sys999%20Attachment/Pasted%20image%2020240522155550.png)

（1）最外层的mysite/目录： 是项目的容器， Django 不关心它的名字，可以将它重命名其他名字。  
（2）manage.py: 一个让你用各种方式管理 Django 项目的命令行工具。比如我们之前用的python manage.py runserver命令。  
（3）里面一层的mysite/目录：包含你的项目，它是一个纯 Python 包。它的名字就是当你引用它内部任何东西时需要用到的 Python 包名。 比如 mysite.urls。  
（4）mysite/__init__.py： 一个空文件，告诉 Python 这个目录应该被认为是一个 Python 包。  
（5）mysite/settings.py：Django 项目的配置文件。后面会详细说到。  
（6）mysite/urls.py：Django 项目的 URL 路由系统，就像你网站的“目录”。  
（7）mysite/wsgi.py：作为你的项目的运行在 WSGI 兼容的Web服务器上的入口。后面会详细说到。  
（8）db.sqlite3 是django默认使用的sqlite3数据库文件。
# 安装 pika

```zsh
pip3 install pika
```
## pika 的封装

```Python
import pika

class RabbitMQClient:
    def __init__(self, host='localhost', port=5672, username='itcast', password='123321', exchange_name='java-python-exchange', exchange_type='direct'):
        self.host = host
        self.port = port
        self.username = username
        self.password = password
        self.exchange_name = exchange_name
        self.exchange_type = exchange_type
        self.connection = None
        self.channel = None

    def connect(self):
        credentials = pika.PlainCredentials(self.username, self.password)
        parameters = pika.ConnectionParameters(host=self.host, port=self.port, credentials=credentials)
        self.connection = pika.BlockingConnection(parameters)
        self.channel = self.connection.channel()
        # 声明交换机
        self.channel.exchange_declare(exchange=self.exchange_name, exchange_type=self.exchange_type,durable=True)

    def close(self):
        if self.connection and not self.connection.is_closed:
            self.connection.close()

    def send_message(self, routing_key, message):
        self.channel.basic_publish(exchange=self.exchange_name, routing_key=routing_key, body=message)

    def receive_message(self, queue, routing_key,callback ):
        self.channel.queue_declare(queue=queue,durable=True)
        self.channel.queue_bind(exchange=self.exchange_name, queue=queue, routing_key=routing_key)
        self.channel.basic_consume(queue=queue, on_message_callback=callback, auto_ack=True)
        self.channel.start_consuming()
```
# Python 与 MQ 通信 Demo

```java
from DjangoMqDemo.python_client.rabbitmq_client import RabbitMQClient
import threading

def start():
    def callback(ch, method, properties, body):
        print(f"Python端接收到Java发来的消息：【{body}】")
        client = RabbitMQClient()
        client.connect()
        client.send_message(routing_key="java",message="hello java")
        print(f"Python端已经向Java端发送信息！")
        client.close()

    def consume():
        print("consume")
        client = RabbitMQClient()
        client.connect()
        client.receive_message(queue="java-python-queue",routing_key="python",callback=callback)
        client.close()

    # 启动一个线程来消费消息
    thread = threading.Thread(target=consume)
    thread.start()
```




